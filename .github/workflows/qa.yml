name: QA pipeline for RDS blueprints

on:
  push:
    branches: [main]
    paths-ignore:
      - .github/**
      - .gitignore
      - .pre-commit-config.yaml
      - .tflint.hcl
      - LICENSE
      - README.md
      - renovate.json
      - tests/**

  workflow_dispatch:

concurrency: terragrunt

defaults:
  run:
    shell: bash

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_BLUEPRINTS_QA_DEPLOY_AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_BLUEPRINTS_QA_DEPLOY_AWS_SECRET_ACCESS_KEY }}
  QA_INSTANCE_DIR: tests/instance
  QA_SCRIPT: tests/scripts/dummy.sh

jobs:
  test-env-vars:
    runs-on: ubuntu-latest
    container:
      image: dfdsdk/prime-pipeline:0.6.37
    steps:
      - name: Check environment variables
        run: bash -c '[[ -z $AWS_ACCESS_KEY_ID || -z $AWS_SECRET_ACCESS_KEY ]] && exit 1 || true'

      # - name: Send alert if job fails
      #   if: failure()
      #   uses: dfds/shared-workflows/.github/actions/automation-slack-notifier@master
      #   with:
      #     slack_webhook: ${{ secrets.SLACK_WEBHOOK }}
      #     slack_message: Test environment variables failed.

  rds-qa-test:
    runs-on: ubuntu-latest
    needs: test-env-vars
    container:
      image: dfdsdk/prime-pipeline:0.6.37
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Create test database
        run: |
          terragrunt run-all apply --terragrunt-working-dir ./${QA_INSTANCE_DIR} --terragrunt-source-update --terragrunt-non-interactive -input=false -auto-approve

      - name: Run test cases
        run: |
          ${QA_SCRIPT:}

      - name: Destroy test database
        run: |
          terragrunt run-all destroy --terragrunt-working-dir ./${QA_INSTANCE_DIR} --terragrunt-source-update --terragrunt-non-interactive -input=false -auto-approve

      # - name: Send alert if job fails
      #   if: failure()
      #   uses: dfds/shared-workflows/.github/actions/automation-slack-notifier@master
      #   with:
      #     slack_webhook: ${{ secrets.SLACK_WEBHOOK }}
      #     slack_message: QA pipeline for RDS blueprints failed.
